<!-- 
    © 2023 Verifiable Draws
    https://www.verifiabledraws.com/

    This code is licensed under AGPL v3 license,
    see https://www.gnu.org/licenses/agpl-3.0.en.html for details.
-->
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">
    <meta http-equiv="Content-Security-Policy" content="
        default-src *  data: blob: filesystem: about: ws: wss: 'unsafe-inline' 'unsafe-eval'; 
        script-src * data: blob: 'unsafe-inline' 'unsafe-eval'; 
        connect-src * data: blob: 'unsafe-inline'; 
        img-src * data: blob: 'unsafe-inline'; 
        frame-src * data: blob: ; 
        style-src * data: blob: 'unsafe-inline';
        font-src * data: blob: 'unsafe-inline';
    ">

    <title>{{ drawTitle }}</title>
    <link rel="icon" href="https://bafybeigotrptu2ge7ykwvd5xek5qphaui3wlekqggl5qnt425n6t4ekgfy.ipfs.w3s.link/favicon.ico" />

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="https://bafybeic4bjns5wmus67vvn4oixpd5xg3xm3hndprhkcya4tc4ww3reaeny.ipfs.w3s.link/styles.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@100;200;300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Fireworks animation -->
    <script src="https://bafybeidmyj27yy6zit6tjc7d5rcftdkfzupljpkzzltatfqdlcz5fb56iq.ipfs.w3s.link/index.umd.js"></script>

    <script type="module">

        const url = window.location.href;
        const cid = url.slice(8).split('.')[0]
        populateDom('cid', cid)

        const network = '{{ network }}';
        populateDom('network', network)

        const contractAddress = '{{ contractAddress }}';
        populateDom('contractAddress', contractAddress)

        // Fetch storage proofs
        const statusResponse = await fetch(`https://www.verifiabledraws.com/api/draw/status?rootCid=${cid}`)
        const drawStatus = await statusResponse.json();
        console.log('drawStatus = ');
        console.log(drawStatus);

        const drawParticipants = [{{ drawParticipants }}];
        document.getElementsByClassName("var_drawParticipants")[0].innerHTML = drawParticipants.map(p => `<li>${p}</li>`).join('');

        const drawNbParticipants = {{ drawNbParticipants }};
        populateDom('drawNbParticipants', drawNbParticipants)

        const fireworksElmt = document.querySelector('.fireworks');
        const fireworks = new Fireworks.default(fireworksElmt);

        // Handling time
        const timestamp = {{ drawScheduledAt }}; // in sec
        const scheduledAt = new Date(timestamp * 1000);
        const scheduledAtString = new Intl.DateTimeFormat('fr-FR', { dateStyle: 'medium', timeStyle: 'short' }).format(scheduledAt);
        populateDom('scheduledAtString', scheduledAtString)
        const scheduledAtElmt = document.getElementsByClassName("scheduledAt")[0];
        const loadingElmt = document.getElementsByClassName("draw-ongoing")[0];
        const isDrawOngoing = scheduledAt.getTime() <= Date.now();

        if (isDrawOngoing) {
            scheduledAtElmt.style.display = 'none';
            loadingElmt.style.display = 'block';
            periodicallyCheckDrawResult();
        }

        // Modal
        let modal;
        document.addEventListener("click", (e) => {
            if (e.target.className === "verifiable-code-modal-open" || e.target.className === "verifiable-outcome-modal-open") {
                modal = document.getElementById(e.target.dataset.id);
                openModal(modal);
            } else if (e.target.className === "modal-close" || e.target.id !== "") {
                closeModal(modal);
            } else {
                return;
            }
        });

        function openModal(modal) {
            document.body.style.overflow = "hidden";
            modal.setAttribute("open", "true");
            document.addEventListener("keydown", escClose);
            let overlay = document.createElement("div");
            overlay.id = "modal-overlay";
            document.body.appendChild(overlay);
        }

        function closeModal(modal) {
            document.body.style.overflow = "auto";
            modal.removeAttribute("open");
            document.removeEventListener("keydown", escClose);
            document.body.removeChild(document.getElementById("modal-overlay"));
        }

        function escClose(e) {
            if (e.keyCode == 27) {
                closeModal(modal);
            }
        }

        // For a JS variable X, insert the value of X in all elements <span class="var_X">
        function populateDom(variableName, variableValue) {
            console.log(`${variableName} = ${variableValue}`);
            const elmts = document.getElementsByClassName(`var_${variableName}`);
            for (let i = 0; i < elmts.length; i++) {
                elmts[i].innerHTML = variableValue;
            }
        }

        // Check now & every minute
        async function periodicallyCheckDrawResult() {
            const [done, randomness] = await checkDrawResult();

            if (done) {

                pickWinners(randomness);

            } else {
                setTimeout(() => {
                    periodicallyCheckDrawResult();
                }, 1000 * 60);
            }
        }

        async function checkDrawResult() {

            // You can verify that the returned randomness match the one at https://polygonscan.com/address/0x6deb09b11ee7e831db4cd96360916b7c36aa70b1#readContract#F2
            let randomnessResponse = await fetch(`https://www.verifiabledraws.com/api/blockchain/getRandomnessForDraw?network=${network}&contractAddress=${contractAddress}&cid=${cid}`);
            const randomness = await randomnessResponse.json();
            console.log('randomness = ');
            console.log(randomness);

            return [randomness.bytes != '0x', randomness.bytes];
        }

        async function pickWinners(randomness) {
            console.log(`We have some winners !`);
            loadingElmt.style.display = 'none';
            scheduledAtElmt.style.display = 'block';

            // Launch fireworks animation
            launchFireworks(10, 100);

            const winnersElement = document.getElementsByClassName("winners")[0];
            const winnersListElement = winnersElement.getElementsByClassName("winners__list")[0];

            winnersElement.style.display = 'block';

            const decimalRandomness = BigInt(randomness); // parseInt(randomness.slice(2), 16);
            console.log(`decimalRandomness = ${decimalRandomness}`);
            const nbDigitsPerWinner = getNbDigits(drawNbParticipants);
            console.log(`nbDigitsPerWinner = ${nbDigitsPerWinner}`);
            const winnerIndexes = splitIn(decimalRandomness, nbDigitsPerWinner);
            console.log(`winnerIndexes = ${winnerIndexes}`);
            const winnersNeeded = {{ drawNbWinners }};
            const pickedIndexes = [];


            for (let i = 0; i < winnerIndexes.length; i++) {
                if (i === winnersNeeded) {
                    break;
                }

                const winnerIndex = winnerIndexes[i] % drawParticipants.length;
                const winner = drawParticipants.splice(winnerIndex, 1)[0];
                winnersListElement.innerHTML += `<li>${winner}</li>`;
            }
        }

        function getNbDigits(number) {
            return number.toString().length;
        }

        // Split {number} in an array of {nbDigits} digit numbers
        function splitIn(number, nbDigits) {

            let output = [],
            sNumber = number.toString();

            for (let i = 0, len = sNumber.length; i < len; i += nbDigits) {
                output.push(+sNumber.substring(i, i + nbDigits));
            }

            return output;
        }

        function launchFireworks(nb, delay, first = true) {
            if (first && nb > 0) {
                fireworksElmt.style.display = 'block';
                fireworks.launch(1);
                nb--;
            }

            if (nb > 0) {

                setTimeout(() => {
                    fireworks.launch(1);
                    nb--;
                    launchFireworks(nb, delay, false);
                }, delay);

            }

            if (nb == 0) {
                setTimeout(() => {
                    fireworksElmt.style.display = 'none';
                }, 2000);
            }
        }
    </script>
</head>

<body>
    <header>

        <div>
            <img alt="" class="certified-section__img" src="https://bafybeifedhpogtuuu2rd4medlgpjzjxsyvgkfd5xibjm47slrr4kq4q7pi.ipfs.w3s.link/success_tick_icon.png" />
        </div>

        <div class="certified-section__txt">
            <p>
                This draw is performed by a decentralized algorithm whose code and result are both verifiable
                by any participant at any time, which guarantees that the draw is completely fair and random.
            </p>
            <p class="powered-by">
                Powered by <a href="https://www.verifiabledraws.com/" target="_blank">Verifiable Draws</a>
            </p>
        </div>

    </header>
    <div class="main">
        <div class="first-line">
            <h1>{{ drawTitle }}</h1>
            <h3 class="scheduledAt">Draw scheduled for <span class="var_scheduledAtString"></span></h3>
            <div class="draw-ongoing">
                <div class="first-line">
                    <div class="lds-dual-ring"></div>
                    <h3>Draw in progress, please wait...</h3>
                </div>
            </div>
        </div>
        <hr />

        <div class="draw-parameter winners">
            <h2>Draw winners:</h2>
            <ul class="draw-parameter__value winners__list">
            </ul>
            <p class="draw-parameter__value verify-sentence">
                You don't trust this result ?
                <a href="#" class="verifiable-outcome-modal-open" data-id="verifiable-outcome-modal">
                    Verify it yourself !
                </a>
            </p>
            <hr />
        </div>

        <div class="draw-parameter">
            <h2>Rules:</h2>
            <p class="draw-parameter__value">
                {{ drawRules }}
            </p>
        </div>

        <div class="draw-parameter">
            <h2><span class="var_drawNbParticipants"></span> Participants:</h2>
            <ul class="draw-parameter__value var_drawParticipants">
            </ul>
        </div>


    </div>
    <footer></footer>

    <!-- Fireworks animation -->
    <div class="fireworks"></div>

    <!-- Verifiable outcome modal -->
    <div id="verifiable-outcome-modal" class="modal" role="dialog" tabindex="-1">
        <div class="model-inner">
            <div class="modal-header">
                <h3>Verify the draw winners</h3>
                <span class="modal-close" data-id="verifiable-outcome-modal" aria-label="Close">
                    &times;
                </span>
            </div>
            <p>
                This draw is a <a href="https://www.verifiabledraws.com/" target="_blank">verifiable draw</a>,
                which means that any participant can verify that the draw was performed in a fair and random way.<br />
                The good news is that you don't need to be an IT expert to verify it.<br />
                Here are some simple steps to follow :

            <h3>Verify the draw parameters</h3>
            <hr />
            This web page contains all the draw parameters : the name of the draw, the rules of the draw, the date and
            time at which the draw should be triggered, the list of participants, the number of participants to draw,
            the address of the smart contract where the random number will be picked, and how this random number will be
            converted into a list of winners.
            To prevent anyone from modifying these parameters and thus from rigging the draw, this page is not stored on
            the regular centralized Web (also known as web2), it is instead stored on the decentralized Web (known as
            web3) thanks to a technology called <a href="https://ipfs.tech/" target="_blank">IPFS</a>. Everything which
            is stored using IPFS cannot be modified once it is published. It is indeed what we want for the draw
            parameters.
            <br /><br />
            If you want to check that this page is indeed stored on IPFS, first copy the unique ID of this draw that you
            can find in the URL (<span class="var_cid"></span> in this case), then download an IPFS-compatible browser
            like <a href="https://brave.com/" target="_blank">Brave</a> open the URL
            <code>ipfs://<span class="var_cid"></span></code> in Brave and compare its source code with the source code
            of this page. If they are identical, it means that this page is indeed stored on IPFS, so it unforgeable and
            you have the guarantee that the draw parameters cannot be rigged.
            <br /><br />
            ℹ️ You can access the source code of a page with <code>Right click > View page source</code>, and you can
            compare the difference between source codes with an online tool such as <a href="https://www.diffchecker.com/" target="_blank">this one</a>.
            <br /><br />
            You can also perform an additional verification on the list of participants to verify that it is the correct
            list. In order to do that, you can check for each participant of the list if it has respected the rules of
            the draw and has deserved its place in the list.


            <h3>Verify the smart contract</h3>
            <hr />
            We have published a smart contract on the Polygon blockchain which aims to transparently associate a random
            number to each draw. Once the association is done, it communicates the generated randomness to this current
            page in order to be convertes. The code is available
            <a href="https://polygonscan.com/address/{{ contractAddress }}#code" target="_blank">here</a> and is
            guaranteed to be correct because of the mention <code>Contract Source Code Verified (Exact Match)</code>.
            <br /><br />
            The main and most important file is VerifiableDraws.sol. All the other files are Chainlink dependencies
            which enable some <a href="https://chain.link/automation" target="_blank">automation tasks</a> and <a href="https://chain.link/vrf" target="_blank">randomness generation</a>.

            <h3>Verify the randomness</h3>
            <hr />
            Finally, you

            Cette page contient tous les paramètres nécessaires au bon déroulement du tirage :
            le nom du tirage, le règlement, la date et l'heure de déclenchement, la liste des participants, le nombre de
            participants à tirer au sort, ainsi que la manière dont les nombres aléatoires sont utilisés pour déterminer
            les participants à sélectionner.
            <br /><br />
            Pour éviter que quiconque ne modifie ces données, nous utilisons la technologie <a href="https://ipfs.tech/" target="_blank">IPFS</a> qui fournit des URLs pointant vers des pages dont le code source ne peut pas
            être modifié.
            <br /><br />
            Dans le cadre de ce tirage, l'URL du tirage est
            <code>https://www.verify.win/ipfs/<span class="var_cid"></span></code> qui pointe en fait vers l'URL
            <code>ipfs://<span class="var_cid"></span></code> dont le contenu est infalsifiable.
            <br /><br />
            Vous pouvez utiliser un navigateur compatible avec IPFS tel que <a href="https://brave.com/fr/" target="_blank">Brave</a> pour accéder à ces 2 adresses et vérifier que leur contenu est identique, ce
            qui prouve que les données du tirage n'ont pas été altérées depuis la création du tirage.
            <br /><br />
            Une explication détaillée du fonctionnement d'IPFS est disponible <a href="https://ipfs.tech/#how" target="_blank">sur leur site</a>.
            </p>
        </div>
    </div>


</body>

</html>