<!-- 
    © 2023 Verifiable Draws
    https://www.verifiabledraws.com/

    This code is licensed under AGPL v3 license,
    see https://www.gnu.org/licenses/agpl-3.0.en.html for details.
-->
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">

    <title>{{ drawTitle }}</title>
    <!-- <link rel="icon" href="images/favicon.png" /> -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Equivalent to https://unpkg.com/fireworks-js@2.x/dist/index.umd.js -->
    <script src="https://bafybeidmyj27yy6zit6tjc7d5rcftdkfzupljpkzzltatfqdlcz5fb56iq.ipfs.dweb.link/index.umd.js"></script>
    
    <script type="module">

        // Equivalent to https://cdn.ethers.io/lib/ethers-5.7.esm.min.js
        import { ethers } from "https://bafybeihbbwwchkazi6gb6weqqehhyj3h2kioohwxqfhkea2cb4z7vfx2p4.ipfs.dweb.link/ethers-5.7.esm.min.js";

        const providerURL = '{{ providerURL }}';
        populateDom('providerURL', providerURL)
        const provider = new ethers.providers.JsonRpcProvider(providerURL);
        
        const contractAddress = '{{ contractAddress }}';
        populateDom('contractAddress', contractAddress)

        const contract = new ethers.Contract(contractAddress, [
            'function getRandomnessForDraw(string cid) external view returns (bytes memory)',
        ], provider);

        const url = window.location.href;
        populateDom('url', url)

        const stringCID = url.slice(8).split('.')[0]
        populateDom('stringCID', stringCID)

        const drawParticipants = [{{ drawParticipants }}];
        document.getElementsByClassName("var_drawParticipants")[0].innerHTML = drawParticipants.map(p => `<li>${p}</li>`).join('');

        const drawNbParticipants = {{ drawNbParticipants }};
        populateDom('drawNbParticipants', drawNbParticipants)

        const fireworksElmt = document.querySelector('.fireworks');
        const fireworks = new Fireworks.default(fireworksElmt);

        // Handling time
        const timestamp = {{ drawScheduledAt }}; // in sec
        const scheduledAt = new Date(timestamp * 1000);
        const scheduledAtString = new Intl.DateTimeFormat('fr-FR', { dateStyle: 'medium', timeStyle: 'short' }).format(scheduledAt);
        populateDom('scheduledAtString', scheduledAtString)
        const scheduledAtElmt = document.getElementsByClassName("scheduledAt")[0];
        const loadingElmt = document.getElementsByClassName("draw-ongoing")[0];
        const isDrawOngoing = scheduledAt.getTime() <= Date.now();

        if (isDrawOngoing) {
            scheduledAtElmt.style.display = 'none';
            loadingElmt.style.display = 'block';
            periodicallyCheckDrawResult();
        }

        fetch(`https://www.verifiabledraws.com/api/draw/status?rootCid=${stringCID}`)
            .then((response) => {
                console.log(`response = ${response}`);
            })

        // Modal
        let modal;
        document.addEventListener("click", (e) => {
            if (e.target.className === "verifiable-code-modal-open" || e.target.className === "verifiable-outcome-modal-open") {
                modal = document.getElementById(e.target.dataset.id);
                openModal(modal);
            } else if (e.target.className === "modal-close" || e.target.id !== "") {
                closeModal(modal);
            } else {
                return;
            }
        });

        const openModal = (modal) => {
            document.body.style.overflow = "hidden";
            modal.setAttribute("open", "true");
            document.addEventListener("keydown", escClose);
            let overlay = document.createElement("div");
            overlay.id = "modal-overlay";
            document.body.appendChild(overlay);
        };

        const closeModal = (modal) => {
            document.body.style.overflow = "auto";
            modal.removeAttribute("open");
            document.removeEventListener("keydown", escClose);
            document.body.removeChild(document.getElementById("modal-overlay"));
        };

        const escClose = (e) => {
            if (e.keyCode == 27) {
                closeModal(modal);
            }
        };

        // For a JS variable X, insert the value of X in all elements <span class="var_X">
        function populateDom(variableName, variableValue) {
            console.log(`${variableName} = ${variableValue}`);
            const elmts = document.getElementsByClassName(`var_${variableName}`);
            for (let i = 0; i < elmts.length; i++) {
                elmts[i].innerHTML = variableValue;
            }
        }

        // Check now & every minute
        async function periodicallyCheckDrawResult() {
            const [done, entropy] = await checkDrawResult();

            if (done) {

                pickWinners(entropy);

            } else {
                setTimeout(() => {
                    periodicallyCheckDrawResult();
                }, 1000 * 60);
            }
        }

        async function checkDrawResult() {

            let entropy = await contract.getRandomnessForDraw(stringCID);
            console.log(`entropy = ${entropy}`);
            return [entropy != '0x', entropy];
        }

        async function pickWinners(entropy) {
            console.log(`We have some winners !`);
            loadingElmt.style.display = 'none';
            scheduledAtElmt.style.display = 'block';

            // Launch fireworks animation
            launchFireworks(10, 200);

            const winnersElement = document.getElementsByClassName("winners")[0];
            const winnersListElement = winnersElement.getElementsByClassName("winners__list")[0];

            winnersElement.style.display = 'block';

            const decimalEntropy = BigInt(entropy); // parseInt(entropy.slice(2), 16);
            console.log(`decimalEntropy = ${decimalEntropy}`);
            const nbDigitsPerWinner = getNbDigits(drawNbParticipants);
            console.log(`nbDigitsPerWinner = ${nbDigitsPerWinner}`);
            const winnerIndexes = splitIn(decimalEntropy, nbDigitsPerWinner);
            console.log(`winnerIndexes = ${winnerIndexes}`);
            const winnersNeeded = {{ drawNbWinners }};
            const pickedIndexes = [];


            for (let i = 0; i < winnerIndexes.length; i++) {
                if (i === winnersNeeded) {
                    break;
                }

                const winnerIndex = winnerIndexes[i] % drawParticipants.length;
                const winner = drawParticipants.splice(winnerIndex, 1)[0];
                winnersListElement.innerHTML += `<li>${winner}</li>`;
            }
        }

        function getNbDigits(number) {
            return number.toString().length;
        }

        // Split {number} in an array of {nbDigits} digit numbers
        function splitIn(number, nbDigits) {

            let output = [],
            sNumber = number.toString();

            for (let i = 0, len = sNumber.length; i < len; i += nbDigits) {
                output.push(+sNumber.substring(i, i + nbDigits));
            }

            return output;
        }

        function launchFireworks(nb, delay, first = true) {
            if (first && nb > 0) {
                fireworksElmt.style.display = 'block';
                fireworks.launch(1);
                nb--;
            }

            if (nb > 0) {

                setTimeout(() => {
                    fireworks.launch(1);
                    nb--;
                    launchFireworks(nb, delay, false);
                }, delay);

            }
            
            if (nb == 0) {
                setTimeout(() => {
                    fireworksElmt.style.display = 'none';
                }, 2000);
            }
        }
    </script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            margin: 0px;
            width: 100%;
            font-size: 1.1em;
        }

        header {
            display: flex;
            align-items: center;
            color: #338a39;
            background: #d2ecd2;
            padding: 16px 64px;
            border-bottom: 1px solid #338a39;
            width: 100%;
            position: fixed;
            top: 0px;
        }

        .main {
            padding: 16px 64px;
            width: 100%;
            margin-top: 105px;
        }

        header a {
            color: inherit;
        }

        .certified-section__img {
            height: 32px;
            margin-right: 32px;
        }

        .certified-section__txt {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: end;
        }

        ul {
            list-style: decimal-leading-zero;
        }

        li {
            padding-left: 8px;
            margin: 8px 0px;
        }

        .first-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .powered-by {
            font-size: .7em;
            text-align: end;
            min-width: 300px;
            margin-left: 32px;
        }

        .draw-parameter {
            margin: 48px 0px;
        }

        .winners {
            display: none;
        }

        .winners h2 {
            background-image: linear-gradient(to left, violet, indigo, blue, green, yellow, orange, red);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            width: 265px;
        }

        .winners ul {
            color: #338a39;
        }

        .draw-parameter h2 {
            text-transform: uppercase;
        }

        .draw-parameter__value {
            font-size: 1.1em;
            line-height: 1.8em;
        }

        .draw-parameter__value a {
            color: #0000EE;
        }

        .verify-sentence {
            font-size: 0.8em;
        }

        code {
            padding: 0.2em 0.4em;
            margin: 0;
            white-space: break-spaces;
            background-color: rgba(175, 184, 193, 0.2);
            border-radius: 6px;
        }

        .fireworks {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            display: none;
        }

        .lds-dual-ring {
            display: inline-block;
            width: 32px;
            height: 32px;
            margin-right: 24px;
        }

        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 1px solid #000000;
            border-color: #000000 transparent #000000 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }

        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .draw-ongoing {
            display: none;
        }

        /* Modal */
        .modal {
            display: none;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 1;
            width: 100%;
            height: 100%;
            top: 0px;
        }
        .modal[open] {
            display: flex;
        }
        .model-inner {
            background-color: white;
            max-width: 60%;
            padding: 2em;
            margin: auto;
            font-size: 1.1em;
            line-height: 1.6em;
            overflow: scroll;
            height: 100%;
        }
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid black;
        }
        #modal-overlay {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            background-color: black;
            opacity: 0.5;  
        }
        .modal-close {
            color: #aaaaaa;
            float: right;
            font-size: 2.2em;
            font-weight: 100;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <header>

        <div>
            <img alt="" class="certified-section__img"
                src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAIAAAACACAYAAADDPmHLAAAACXBIWXMAAAsTAAALEwEAmpwYAAADPklEQVR4nO3cvW7UQBSG4YgSGgQdUHAhwNr5WxsicTXUW/AjRIlECQVlYieIghKJCwBECwVcA6QHk8UJAe/GO/bMOTPnfST33nk/W1usdm0NAAAAAAAAAAAAauTV9N7mq80r0vcBAVldPMrr8mdeF5/Xd+9clb4fBHQSv70YgRn/x2cEZiyOzwiSd3Z8RpCs/vEZQXJWj88IkuEenxFEb3j8kxFM6uKa9OfBCsaLf3x9YQSR8BB/flXl18nB9Lr058MS3uIzAv28x2cEegWLzwj0yaviYdD4jEAPsfh/rubN840RCJGOzwgEaYnPCARkdflEOnj3VVTSZ5M8bU/+8VUVHzf2Ny5Ln0/SiG8Y8Q0jvmHEN4z4hhHfMOIbRnzDiG8Y8Q0jvmHEN6w56AfioYkvg/iGEd8w4htGfMOIbxjxDSO+o2yv2Mir8tlsNjsnfS+umvt/LB6648qq8v327vYl6fNZKK9u38rq8nB+s8WLGEfAk+/od/zmRn+cXmxcIyC+o674sY2A+I7W96Y3F8WPZQTEd9QnvvYREN/RKvG1joD4jlziaxsB8R0Nia9lBMR3NEZ86REQ39GY8aVGQHxHPuKHHkFWF/fFQ8cYf7Jf3PAVP9QIiO8oRHzfIyC+o5DxfY2A+I4k4o89AuI7kow/1giI70hD/KEjIL6jo/hV8V38oAaMgPgDNIf9RvygukZQl8/7jCD4v273HrHyn3G1dl7vnG8O8a30gXUf4vI3AU/+SGIcAfFHFtMIiO9JDCMgvmdbL7cuNIf8TvxAu0ZQl5+k76F7nJF84etL85tA3ZXKk/8vRmA4fosRGI7fYgSG47cYgeH4LUZgOH7L9Aisx2+ZHAHxTzM1AuJ3MzEC4i+X9AiI30+SIyD+apIaAfHdJDEC4g8T9QiIP44oR0D8cUU1AuL7EcUIiO+X6hEQPwyVIyB+WKpGQHwZKkZAfFmiIyC+DiIjIL4uQUdAfJ2CjID4unkdAfHj4GUExI/LqCMgfpxGGQHx4zZoBMRPg9MIiJ+WVf6kIrk/Z8BczzfBB578hJ0xAuJb0DUCXvvG/D0C4ht19MWwKp9ODu5elL4XAAAAAAAAAACAWPwCzoJCzBdMJesAAAAASUVORK5CYII=" />

        </div>
        <div class="certified-section__txt">
            <p>
                This draw is performed by a decentralized algorithm whose code and result are both verifiable 
                by any participant at any time, which guarantees that the draw is completely fair and random.
            </p>
            <p class="powered-by">
                Powered by <a href="https://www.verifiabledraws.com/" target="_blank">Verifiable Draws</a>
            </p>
        </div>

    </header>
    <div class="main">
        <div class="first-line">
            <h1>{{ drawTitle }}</h1>
            <h3 class="scheduledAt">Draw scheduled for <span class="var_scheduledAtString"></span></h3>
            <div class="draw-ongoing">
                <div class="first-line">
                    <div class="lds-dual-ring"></div>
                    <h3>Draw in progress, please wait...</h3>
                </div>
            </div>
        </div>
        <hr />

        <div class="draw-parameter winners">
            <h2>Draw winners:</h2>
            <ul class="draw-parameter__value winners__list">
            </ul>
            <p class="draw-parameter__value verify-sentence">
                You don't trust this result ?
                <a href="#" class="verifiable-outcome-modal-open" data-id="verifiable-outcome-modal">
                    Verify it yourself !
                </a>
            </p>
            <hr />
        </div>

        <div class="draw-parameter">
            <h2>Rules:</h2>
            <p class="draw-parameter__value">
                {{ drawRules }}
            </p>
        </div>

        <div class="draw-parameter">
            <h2><span class="var_drawNbParticipants"></span> Participants:</h2>
            <ul class="draw-parameter__value var_drawParticipants">
            </ul>
        </div>


    </div>
    <footer></footer>

    <!-- Fireworks animation -->
    <div class="fireworks"></div>

    <!-- Verifiable outcome modal -->
    <div id="verifiable-outcome-modal" class="modal" role="dialog" tabindex="-1">
        <div class="model-inner">
            <div class="modal-header">
                <h3>Verify the draw winners</h3>
                <span class="modal-close" data-id="verifiable-outcome-modal" aria-label="Close">
                    &times;
                </span>
            </div>
            <p>
                This draw is a <a href="https://www.verifiabledraws.com/" target="_blank">verifiable draw</a>, 
                which means that any participant can verify that the draw was performed in a fair and random way.<br />
                The good news is that you don't need to be an IT expert to verify it.<br />
                Here are some simple steps to follow :

                <h3>Verify the draw parameters</h3>
                <hr />
                This web page contains all the draw parameters : the name of the draw, the rules of the draw, the date and time at which the draw should be triggered, the list of participants, the number of participants to draw, the address of the smart contract where the random number will be picked, and how this random number will be converted into a list of winners.
                To prevent anyone from modifying these parameters and thus from rigging the draw, this page is not stored on the regular centralized Web (also known as web2), it is instead stored on the decentralized Web (known as web3) thanks to a technology called <a href="https://ipfs.tech/" target="_blank">IPFS</a>. Everything which is stored using IPFS cannot be modified once it is published. It is indeed what we want for the draw parameters.
                <br /><br />
                If you want to check that this page is indeed stored on IPFS, first copy the unique ID of this draw that you can find in the URL (<span class="var_stringCID"></span> in this case), then download an IPFS-compatible browser like <a href="https://brave.com/" target="_blank">Brave</a> open the URL <code>ipfs://<span class="var_stringCID"></span></code> in Brave and compare its source code with the source code of this page. If they are identical, it means that this page is indeed stored on IPFS, so it unforgeable and you have the guarantee that the draw parameters cannot be rigged.
                <br /><br />
                ℹ️ You can access the source code of a page with <code>Right click > View page source</code>, and you can compare the difference between source codes with an online tool such as <a href="https://www.diffchecker.com/" target="_blank">this one</a>.
                <br /><br />
                You can also perform an additional verification on the list of participants to verify that it is the correct list. In order to do that, you can check for each participant of the list if it has respected the rules of the draw and has deserved its place in the list.


                <h3>Verify the smart contract</h3>
                <hr />
                We have published a smart contract on the Polygon blockchain which aims to transparently associate a random number to each draw. Once the association is done, it communicates the generated randomness to this current page in order to be convertes. The code is available 
                <a href="https://polygonscan.com/address/{{ contractAddress }}#code" target="_blank">here</a> and is guaranteed to be correct because of the mention <code>Contract Source Code Verified (Exact Match)</code>.
                <br /><br />
                The main and most important file is VerifiableDraws.sol. All the other files are Chainlink dependencies which enable some <a href="https://chain.link/automation" target="_blank">automation tasks</a> and <a href="https://chain.link/vrf" target="_blank">randomness generation</a>.

                <h3>Verify the randomness</h3>
                <hr />
                Finally, you

                Cette page contient tous les paramètres nécessaires au bon déroulement du tirage :
                le nom du tirage, le règlement, la date et l'heure de déclenchement, la liste des participants, le nombre de participants à tirer au sort, ainsi que la manière dont les nombres aléatoires sont utilisés pour déterminer les participants à sélectionner.
                <br /><br />
                Pour éviter que quiconque ne modifie ces données, nous utilisons la technologie <a href="https://ipfs.tech/" target="_blank">IPFS</a> qui fournit des URLs pointant vers des pages dont le code source ne peut pas être modifié.
                <br /><br />
                Dans le cadre de ce tirage, l'URL du tirage est <code>https://www.verify.win/ipfs/<span class="var_stringCID"></span></code> qui pointe en fait vers l'URL <code>ipfs://<span class="var_stringCID"></span></code> dont le contenu est infalsifiable.
                <br /><br />
                Vous pouvez utiliser un navigateur compatible avec IPFS tel que <a href="https://brave.com/fr/" target="_blank">Brave</a> pour accéder à ces 2 adresses et vérifier que leur contenu est identique, ce qui prouve que les données du tirage n'ont pas été altérées depuis la création du tirage.
                <br /><br />
                Une explication détaillée du fonctionnement d'IPFS est disponible <a href="https://ipfs.tech/#how" target="_blank">sur leur site</a>.
            </p>
        </div>
    </div>


</body>

</html>