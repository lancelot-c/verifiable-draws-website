<!-- 
    ¬© 2023 Verifiable Draws
    https://www.verifiabledraws.com/

    This code is licensed under AGPL v3 license,
    see https://www.gnu.org/licenses/agpl-3.0.en.html for details.
-->
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">

    <title>{{ drawTitle }}</title>
    <link rel="icon" href="https://bafybeigotrptu2ge7ykwvd5xek5qphaui3wlekqggl5qnt425n6t4ekgfy.ipfs.w3s.link/favicon.ico" />

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="https://bafybeig72t45uiohr53ctwhw2nl4ec5sm5atc6atskhywbn6hmaroh6fly.ipfs.w3s.link/styles.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Fireworks animation -->
    <script src="https://bafybeidmyj27yy6zit6tjc7d5rcftdkfzupljpkzzltatfqdlcz5fb56iq.ipfs.w3s.link/index.umd.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            margin: 0px;
            width: 100%;
            font-size: 1.1em;
        }

        header {
            display: flex;
            align-items: center;
            color: #338a39;
            background: #d2ecd2;
            border-bottom: 1px solid #338a39;
            width: 100%;
            position: fixed;
            top: 0px;
            padding: 0px;
        }

        .main {
            width: 100%;
            margin-top: 100px;
            overflow-wrap: break-word;
        }

        header a {
            color: inherit;
        }

        .certified {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: end;
        }

        .certified .txt {
            text-align: center;
            width: 100%;
            font-size: .8em;
        }

        .certified .icon {
            margin-right: 16px;
        }

        ul {
            list-style: decimal-leading-zero;
        }

        li {
            padding-left: 8px;
            margin: 8px 0px;
        }

        .first-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .draw-parameter {
            margin: 48px 0px;
        }

        .winners h2 {
            background-image: linear-gradient(to left, violet, indigo, blue, green, yellow, orange, red);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            width: 265px;
        }

        .winners ul {
            color: #338a39;
        }

        .draw-parameter h2 {
            text-transform: uppercase;
        }

        .draw-parameter__value {
            font-size: 1.1em;
            line-height: 1.8em;
        }

        .draw-parameter__value a {
            color: #0000EE;
        }

        .verify-sentence {
            font-size: 0.8em;
        }

        code {
            padding: 0.2em 0.4em;
            margin: 0;
            white-space: break-spaces;
            background-color: rgba(175, 184, 193, 0.2);
            border-radius: 6px;
        }

        .fireworks {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            display: none;
        }

        .lds-dual-ring {
            display: inline-block;
            width: 32px;
            height: 32px;
            margin-right: 24px;
        }

        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #000000;
            border-color: #000000 transparent #000000 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }

        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .scheduledAt, .drawOngoing, .occuredAt, .winners {
            display: none;
        }

        .drawOngoing {
            z-index: -10;
            position: relative;
        }

        /* Modal */
        .modal {
            display: none;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 1;
            width: 100%;
            height: 100%;
            top: 0px;
        }

        .modal[open] {
            display: flex;
        }

        .modal-inner {
            background-color: white;
            margin: auto;
            font-size: 1.1em;
            line-height: 1.6em;
            overflow: scroll;
            overflow-wrap: break-word;
            height: 100%;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid black;
        }

        li.verification-step {
            margin-bottom: 60px;
        }

        li.verification-step strong {
            text-decoration: underline;
        }

        #modal-overlay {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            background-color: black;
            opacity: 0.5;
        }

        .modal-close {
            color: #aaaaaa;
            float: right;
            font-size: 2.2em;
            font-weight: 100;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        @media (max-width: 399px) {
            .main {
                padding: 0px 16px;
            }

            .modal-inner {
                padding: 0.5em;
            }
        }

        @media (min-width: 400px) and (max-width: 699px) {
            .main {
                padding: 0px 32px;
            }

            .modal-inner {
                padding: 1em;
            }
        }

        @media (min-width: 700px) {
            .main {
                padding: 0px 64px;
            }

            .modal-inner {
                padding: 2em;
            }
        }

        @media (max-width: 1249px) {
            .modal-inner {
                max-width: 100%;
            }
        }

        @media (min-width: 1250px) {
            .modal-inner {
                max-width: 60%;
            }
        }
    </style>


    <script type="module">

        const url = window.location.href;

        // In test mode the url is http://localhost:3000/ipfs?cid=XXX whereas in production the url is https://www.verifiabledraws.com/ipfs/XXX
        const isTestMode = url.includes("=");
        const pageSegments = isTestMode ? url.split("=") : url.split("/");
        let cid = pageSegments[pageSegments.length - 1];
        populateDom('cid', cid)
        const cidLinks = document.getElementsByClassName("cidLink");
        for (let i = 0; i < cidLinks.length; i++) {
            cidLinks[i].href = cidLinks[i].href.replace("cid", cid);
        }

        const network = '{{ network }}';
        populateDom('network', network)

        const contractAddress = '{{ contractAddress }}';
        populateDom('contractAddress', contractAddress)

        // Fetch storage proofs
        const statusResponse = await fetch(`https://www.verifiabledraws.com/api/draw/status?cid=${cid}`)
        const drawStatus = await statusResponse.json();
        const drawDeals = drawStatus.deals;
        console.log('Filecoin deals (proofs of storage) = ');
        console.log(drawDeals);

        const drawParticipants = [{{ drawParticipants }}];
        document.getElementsByClassName("var_drawParticipants")[0].innerHTML = drawParticipants.map(p => `<li>${p}</li>`).join('');

        const drawNbParticipants = {{ drawNbParticipants }};
        populateDom('drawNbParticipants', drawNbParticipants)

        const fireworksElmt = document.querySelector('.fireworks');
        const fireworks = new Fireworks.default(fireworksElmt);

        // Handling time
        const timestamp = {{ drawScheduledAt }}; // in sec
        const scheduledAt = new Date(timestamp * 1000);
        const scheduledAtString = new Intl.DateTimeFormat('en-US', { dateStyle: 'medium', timeStyle: 'short' }).format(scheduledAt);
        populateDom('scheduledAtString', scheduledAtString)
        const scheduledAtElmt = document.getElementsByClassName("scheduledAt")[0];
        const loadingElmt = document.getElementsByClassName("drawOngoing")[0];
        const occuredAtElmt = document.getElementsByClassName("occuredAt")[0];
        const isDrawOngoing = scheduledAt.getTime() <= Date.now();

        if (isDrawOngoing) {
            scheduledAtElmt.style.display = 'none';
            loadingElmt.style.display = 'inline-block';
            occuredAtElmt.style.display = 'none';
            periodicallyCheckDrawResult();
        } else {
            scheduledAtElmt.style.display = 'block';
            loadingElmt.style.display = 'none';
        }

        // Modal
        let modal;
        document.addEventListener("click", (e) => {
            if (e.target.className === "verifiable-code-modal-open" || e.target.className === "verifiable-outcome-modal-open") {
                modal = document.getElementById(e.target.dataset.id);
                openModal(modal);
            } else if (e.target.className === "modal-close" || e.target.id !== "") {
                closeModal(modal);
            } else {
                return;
            }
        });

        function openModal(modal) {
            document.body.style.overflow = "hidden";
            modal.setAttribute("open", "true");
            document.addEventListener("keydown", escClose);
            let overlay = document.createElement("div");
            overlay.id = "modal-overlay";
            document.body.appendChild(overlay);
        }

        function closeModal(modal) {
            document.body.style.overflow = "auto";
            modal.removeAttribute("open");
            document.removeEventListener("keydown", escClose);
            document.body.removeChild(document.getElementById("modal-overlay"));
        }

        function escClose(e) {
            if (e.keyCode == 27) {
                closeModal(modal);
            }
        }

        // For a JS variable X, insert the value of X in all elements <span class="var_X">
        function populateDom(variableName, variableValue) {
            console.log(`${variableName} = ${variableValue}`);
            const elmts = document.getElementsByClassName(`var_${variableName}`);
            for (let i = 0; i < elmts.length; i++) {
                elmts[i].innerHTML = variableValue;
            }
        }

        // Check now & every minute
        async function periodicallyCheckDrawResult() {
            const [done, randomness] = await checkDrawResult();

            if (done) {

                pickWinners(randomness);

            } else {
                setTimeout(() => {
                    periodicallyCheckDrawResult();
                }, 1000 * 60);
            }
        }

        async function checkDrawResult() {

            // You can verify that the returned randomness match the one at {{ polygonscanAddress }}/address/{{ contractAddress }}#readContract#F5
            let randomnessResponse = await fetch(`https://www.verifiabledraws.com/api/smart-contract/getRandomnessForDraw?network=${network}&contractAddress=${contractAddress}&cid=${cid}`);
            const randomness = await randomnessResponse.json();
            console.log(`randomness.bytes = ${randomness.bytes}`);

            return [randomness.bytes != '0x', randomness.bytes];
        }

        async function pickWinners(randomness) {
            console.log(`We have some winners üéâ`);
            loadingElmt.style.display = 'none';
            scheduledAtElmt.style.display = 'none';
            occuredAtElmt.style.display = 'block';

            // Launch fireworks animation
            launchFireworks(10, 100);

            const winnersElement = document.getElementsByClassName("winners")[0];
            const winnersListElement = winnersElement.getElementsByClassName("winners__list")[0];

            winnersElement.style.display = 'block';

            const decimalRandomness = BigInt(randomness); // parseInt(randomness.slice(2), 16);
            console.log(`decimalRandomness = ${decimalRandomness}`);
            const nbDigitsPerWinner = getNbDigits(drawNbParticipants);
            console.log(`nbDigitsPerWinner = ${nbDigitsPerWinner}`);
            const winnerIndexes = splitIn(decimalRandomness, nbDigitsPerWinner);
            console.log(`winnerIndexes = ${winnerIndexes}`);
            const winnersNeeded = {{ drawNbWinners }};
            const pickedIndexes = [];


            for (let i = 0; i < winnerIndexes.length; i++) {
                if (i === winnersNeeded) {
                    break;
                }

                const winnerIndex = winnerIndexes[i] % drawParticipants.length;
                const winner = drawParticipants.splice(winnerIndex, 1)[0];
                winnersListElement.innerHTML += `<li>${winner}</li>`;
            }
        }

        function getNbDigits(number) {
            return number.toString().length;
        }

        // Split {number} in an array of {nbDigits} digit numbers
        function splitIn(number, nbDigits) {

            let output = [],
            sNumber = number.toString();

            for (let i = 0, len = sNumber.length; i < len; i += nbDigits) {
                output.push(+sNumber.substring(i, i + nbDigits));
            }

            return output;
        }

        function launchFireworks(nb, delay, first = true) {
            if (first && nb > 0) {
                fireworksElmt.style.display = 'block';
                fireworks.launch(1);
                nb--;
            }

            if (nb > 0) {

                setTimeout(() => {
                    fireworks.launch(1);
                    nb--;
                    launchFireworks(nb, delay, false);
                }, delay);

            }

            if (nb == 0) {
                setTimeout(() => {
                    fireworksElmt.style.display = 'none';
                }, 2000);
            }
        }
    </script>
</head>

<body>
    <header>

        <div class="certified">
            <p class="txt">
                <span class="icon">‚öñÔ∏è</span>Provably-fair and verifiable randomness<br />
                Powered by <a href="https://www.verifiabledraws.com/" target="_blank">Verifiable Draws</a>
            </p>
        </div>

    </header>
    <div class="main">
        <div>
            <h1>{{ drawTitle }}</h1>

            <div>
                <p class="scheduledAt">
                    This draw is scheduled for <span class="var_scheduledAtString"></span>. Come back to this page after this date to see the winners.
                </p>
                <div class="drawOngoing">
                    <div class="first-line">
                        <div class="lds-dual-ring"></div>
                        <p>Draw in progress, please wait...</p>
                    </div>
                </div>
                <p class="occuredAt">
                    This draw occured on <span class="var_scheduledAtString"></span>
                </p>
            </div>
        </div>
        <hr />

        <div class="draw-parameter winners">
            <h2>Draw winners:</h2>
            <ul class="draw-parameter__value winners__list">
            </ul>
            <p class="draw-parameter__value verify-sentence">
                You don't trust this result ?
                <a href="#" class="verifiable-outcome-modal-open" data-id="verifiable-outcome-modal">
                    Verify it yourself !
                </a>
            </p>
            <hr />
        </div>

        <div class="draw-parameter">
            <h2>Rules:</h2>
            <p class="draw-parameter__value">
                {{ drawRules }}
            </p>
        </div>

        <div class="draw-parameter">
            <h2><span class="var_drawNbParticipants"></span> Participants:</h2>
            <ul class="draw-parameter__value var_drawParticipants">
            </ul>
        </div>


    </div>
    <footer></footer>

    <!-- Fireworks animation -->
    <div class="fireworks"></div>

    <!-- Verifiable outcome modal -->
    <div id="verifiable-outcome-modal" class="modal" role="dialog" tabindex="-1">
        <div class="modal-inner">
            <div class="modal-header">
                <h2>How to verify this draw ?</h2>
                <span class="modal-close" data-id="verifiable-outcome-modal" aria-label="Close">
                    &times;
                </span>
            </div>
            <p>
                This draw is a verifiable draw,
                which means that all participants can verify that it is performed in a fair and random way.<br /><br />
                Here are the simple steps to follow :
            </p>

            <ul>
                <li class="verification-step">
                    <strong>Verify the draw parameters</strong><br />
                    This web page contains all the parameters needed for the draw: the name of the draw, the rules, the list of participants, the number of winners to pick, and the date and time at which the draw will happen. You can manually verify that all of these parameters are correct.<br />
                    <br />
                    On top of that, in order to prevent anyone from modifying these parameters we haven't stored this page on the regular web, instead it is stored on the decentralized web, also known as IPFS.<br />
                    <a href="https://ipfs.tech/" target="_blank">IPFS</a> is a peer-to-peer network for storing tamper-proof files on the internet. It's a bit like Google Drive but decentralized and tamper-proof, which means that once a file is published on IPFS, its content cannot change.<br />
                    <br />
                    Every draw URL on verify.win contains an identifier which is the same identifier used by IPFS to access a file (it is called a Content Identifier, or CID).
                    Copy the identifier from the draw URL (<code><span class="var_cid"></span></code>), paste it on any website which allow access to IPFS content, like <a href="https://web3.storage/products/w3link/" class="cidLink" target="_blank">w3s.link</a> for example, and notice that the source code you get from IPFS is the same as this page source code (<code>Right click > View page source</code>). It means that this page is indeed stored on IPFS and is therefore tamper-proof.<br />
                </li>
                <li class="verification-step">
                    <strong>Verify the random number</strong><br />
                    The last thing we need is a random number to select winners randomly.<br />
                    We rely on blockchain technology for that because it is the only way to get verifiable randomness as of today. Randomness generated outside of the blockchain cannot be verifiable because you have no proof that the algorithm used to generate the randomness is actually the one that the organiser claim to be, which is not the case for <a href="https://www.ibm.com/topics/smart-contracts" target="_blank">smart contracts</a> on a blockchain.
                    <br /><br />
                    When this draw reachs his due date, our smart contract will automatically generate a random number for it. Then this page will call the smart contract to retrieve the generated number and use it to select winners.<br />
                    <br />
                    To verify the random number, <a href="{{ polygonscanAddress }}/address/{{ contractAddress }}#readContract#F5" target="_blank">go to our smart contract</a> and call the function <code>getRandomnessForDraw</code> with parameter <code>cid = <span class="var_cid"></span></code> which is the IPFS CID for this draw. You will get a sequence starting with <code>0x</code>.<br />
                    <br />
                    Then go back to this page, <code>Right click > Inspect > Network tab > Refresh the page > Select the request named "getRandomnessForDraw" > Response tab</code>. You will see another sequence starting with <code>0x</code>.<br />
                    <br />
                    If the two sequences are the same the random number used is correct.
                </li>
                <li class="verification-step">
                    <strong>[Optional] Read the code</strong><br />
                    The whole process of the draw is determined by this page and our smart contract which both are open-source, tamper-proof, and verifiable, so anyone can inspect the code.<br />
                    <br />
                    If you do so, you will notice that we generate our random numbers with <a href="https://chain.link/vrf" target="_blank">Chainlink VRF</a> which is a leading verifiable randomness provider on the blockchain.<br />
                    <br />
                    We also use <a href="https://chain.link/automation" target="_blank">Chainlink Automation</a> to add censorship resistance to our draws so that nobody can prevent a draw from happening.
                </li>
            </ul>

            <p>
                That's it, you now know that this draw is not rigged. üôå<br />
                If you have further questions you can reach out to the <i>Verifiable Draws</i> team on <a href="https://discord.gg/3YjqW9MP7H" target="_blank">our Discord server</a>, we will be happy to help you.
            </p>

        </div>
    </div>


</body>

</html>