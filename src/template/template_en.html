<!-- 
    Â© 2023 Verifiable Draws
    https://www.verifiabledraws.com/

    This code is licensed under AGPL v3 license,
    see https://www.gnu.org/licenses/agpl-3.0.en.html for details.
-->
<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1">

    <title>{{ drawTitle }}</title>
    <link rel="icon" href="https://bafybeigotrptu2ge7ykwvd5xek5qphaui3wlekqggl5qnt425n6t4ekgfy.ipfs.w3s.link/favicon.ico" />

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="https://bafybeig72t45uiohr53ctwhw2nl4ec5sm5atc6atskhywbn6hmaroh6fly.ipfs.w3s.link/styles.css" />

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Fireworks animation -->
    <script src="https://bafybeidmyj27yy6zit6tjc7d5rcftdkfzupljpkzzltatfqdlcz5fb56iq.ipfs.w3s.link/index.umd.js"></script>

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Grotesk', sans-serif;
            margin: 0px;
            width: 100%;
            font-size: 1.1em;
        }

        header {
            display: flex;
            align-items: center;
            color: #338a39;
            background: #d2ecd2;
            padding: 16px 64px;
            border-bottom: 1px solid #338a39;
            width: 100%;
            position: fixed;
            top: 0px;
        }

        .main {
            padding: 16px 64px;
            width: 100%;
            margin-top: 105px;
        }

        header a {
            color: inherit;
        }

        .certified-section__img {
            height: 32px;
            margin-right: 32px;
        }

        .certified-section__txt {
            display: flex;
            justify-content: space-between;
            width: 100%;
            align-items: end;
        }

        ul {
            list-style: decimal-leading-zero;
        }

        li {
            padding-left: 8px;
            margin: 8px 0px;
        }

        .first-line {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .powered-by {
            font-size: .7em;
            text-align: end;
            min-width: 300px;
            margin-left: 32px;
        }

        .draw-parameter {
            margin: 48px 0px;
        }

        .winners h2 {
            background-image: linear-gradient(to left, violet, indigo, blue, green, yellow, orange, red);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            width: 265px;
        }

        .winners ul {
            color: #338a39;
        }

        .draw-parameter h2 {
            text-transform: uppercase;
        }

        .draw-parameter__value {
            font-size: 1.1em;
            line-height: 1.8em;
        }

        .draw-parameter__value a {
            color: #0000EE;
        }

        .verify-sentence {
            font-size: 0.8em;
        }

        code {
            padding: 0.2em 0.4em;
            margin: 0;
            white-space: break-spaces;
            background-color: rgba(175, 184, 193, 0.2);
            border-radius: 6px;
        }

        .fireworks {
            position: absolute;
            top: 0px;
            left: 0px;
            width: 100%;
            height: 100%;
            display: none;
        }

        .drawTitle {
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
            padding-right: 64px;
        }

        .lds-dual-ring {
            display: inline-block;
            width: 32px;
            height: 32px;
            margin-right: 24px;
        }

        .lds-dual-ring:after {
            content: " ";
            display: block;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            border: 2px solid #000000;
            border-color: #000000 transparent #000000 transparent;
            animation: lds-dual-ring 1.2s linear infinite;
        }

        @keyframes lds-dual-ring {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .scheduledAt, .drawOngoing, .occuredAt, .winners {
            display: none;
        }

        .no-shrink {
            flex-shrink: 0;
        }

        /* Modal */
        .modal {
            display: none;
            align-items: center;
            justify-content: center;
            position: fixed;
            z-index: 1;
            width: 100%;
            height: 100%;
            top: 0px;
        }

        .modal[open] {
            display: flex;
        }

        .model-inner {
            background-color: white;
            max-width: 60%;
            padding: 2em;
            margin: auto;
            font-size: 1.1em;
            line-height: 1.6em;
            overflow: scroll;
            height: 100%;
        }

        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 2px solid black;
        }

        li.verification-step:not(:last-child) { 
            margin-bottom: 30px;  
        }

        li.verification-step strong {
            text-decoration: underline;
        }

        #modal-overlay {
            width: 100%;
            height: 100%;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 0;
            background-color: black;
            opacity: 0.5;
        }

        .modal-close {
            color: #aaaaaa;
            float: right;
            font-size: 2.2em;
            font-weight: 100;
        }

        .modal-close:hover,
        .modal-close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
    </style>


    <script type="module">

        const cid = window.location.href.split("=")[1];
        populateDom('cid', cid)
        const cidLinks = document.getElementsByClassName("cidLink");
        for (let i = 0; i < cidLinks.length; i++) {
            cidLinks[i].href = cidLinks[i].href.replace("cid", cid);
        }

        const network = '{{ network }}';
        populateDom('network', network)

        const contractAddress = '{{ contractAddress }}';
        populateDom('contractAddress', contractAddress)

        // Fetch storage proofs
        const statusResponse = await fetch(`https://www.verifiabledraws.com/api/draw/status?cid=${cid}`)
        const drawStatus = await statusResponse.json();
        const drawDeals = drawStatus.deals;
        console.log('Filecoin deals (proofs of storage) = ');
        console.log(drawDeals);

        const drawParticipants = [{{ drawParticipants }}];
        document.getElementsByClassName("var_drawParticipants")[0].innerHTML = drawParticipants.map(p => `<li>${p}</li>`).join('');

        const drawNbParticipants = {{ drawNbParticipants }};
        populateDom('drawNbParticipants', drawNbParticipants)

        const fireworksElmt = document.querySelector('.fireworks');
        const fireworks = new Fireworks.default(fireworksElmt);

        // Handling time
        const timestamp = {{ drawScheduledAt }}; // in sec
        const scheduledAt = new Date(timestamp * 1000);
        const scheduledAtString = new Intl.DateTimeFormat('fr-FR', { dateStyle: 'medium', timeStyle: 'short' }).format(scheduledAt);
        populateDom('scheduledAtString', scheduledAtString)
        const scheduledAtElmt = document.getElementsByClassName("scheduledAt")[0];
        const loadingElmt = document.getElementsByClassName("drawOngoing")[0];
        const occuredAtElmt = document.getElementsByClassName("occuredAt")[0];
        const isDrawOngoing = scheduledAt.getTime() <= Date.now();

        if (isDrawOngoing) {
            scheduledAtElmt.style.display = 'none';
            loadingElmt.style.display = 'block';
            occuredAtElmt.style.display = 'none';
            periodicallyCheckDrawResult();
        } else {
            scheduledAtElmt.style.display = 'block';
            loadingElmt.style.display = 'none';
        }

        // Modal
        let modal;
        document.addEventListener("click", (e) => {
            if (e.target.className === "verifiable-code-modal-open" || e.target.className === "verifiable-outcome-modal-open") {
                modal = document.getElementById(e.target.dataset.id);
                openModal(modal);
            } else if (e.target.className === "modal-close" || e.target.id !== "") {
                closeModal(modal);
            } else {
                return;
            }
        });

        function openModal(modal) {
            document.body.style.overflow = "hidden";
            modal.setAttribute("open", "true");
            document.addEventListener("keydown", escClose);
            let overlay = document.createElement("div");
            overlay.id = "modal-overlay";
            document.body.appendChild(overlay);
        }

        function closeModal(modal) {
            document.body.style.overflow = "auto";
            modal.removeAttribute("open");
            document.removeEventListener("keydown", escClose);
            document.body.removeChild(document.getElementById("modal-overlay"));
        }

        function escClose(e) {
            if (e.keyCode == 27) {
                closeModal(modal);
            }
        }

        // For a JS variable X, insert the value of X in all elements <span class="var_X">
        function populateDom(variableName, variableValue) {
            console.log(`${variableName} = ${variableValue}`);
            const elmts = document.getElementsByClassName(`var_${variableName}`);
            for (let i = 0; i < elmts.length; i++) {
                elmts[i].innerHTML = variableValue;
            }
        }

        // Check now & every minute
        async function periodicallyCheckDrawResult() {
            const [done, randomness] = await checkDrawResult();

            if (done) {

                pickWinners(randomness);

            } else {
                setTimeout(() => {
                    periodicallyCheckDrawResult();
                }, 1000 * 60);
            }
        }

        async function checkDrawResult() {

            // You can verify that the returned randomness match the one at {{ polygonscanAddress }}/address/{{ contractAddress }}#readContract#F5
            let randomnessResponse = await fetch(`https://www.verifiabledraws.com/api/smart-contract/getRandomnessForDraw?network=${network}&contractAddress=${contractAddress}&cid=${cid}`);
            const randomness = await randomnessResponse.json();
            console.log(`randomness.bytes = ${randomness.bytes}`);

            return [randomness.bytes != '0x', randomness.bytes];
        }

        async function pickWinners(randomness) {
            console.log(`We have some winners ð`);
            loadingElmt.style.display = 'none';
            scheduledAtElmt.style.display = 'none';
            occuredAtElmt.style.display = 'block';

            // Launch fireworks animation
            launchFireworks(10, 100);

            const winnersElement = document.getElementsByClassName("winners")[0];
            const winnersListElement = winnersElement.getElementsByClassName("winners__list")[0];

            winnersElement.style.display = 'block';

            const decimalRandomness = BigInt(randomness); // parseInt(randomness.slice(2), 16);
            console.log(`decimalRandomness = ${decimalRandomness}`);
            const nbDigitsPerWinner = getNbDigits(drawNbParticipants);
            console.log(`nbDigitsPerWinner = ${nbDigitsPerWinner}`);
            const winnerIndexes = splitIn(decimalRandomness, nbDigitsPerWinner);
            console.log(`winnerIndexes = ${winnerIndexes}`);
            const winnersNeeded = {{ drawNbWinners }};
            const pickedIndexes = [];


            for (let i = 0; i < winnerIndexes.length; i++) {
                if (i === winnersNeeded) {
                    break;
                }

                const winnerIndex = winnerIndexes[i] % drawParticipants.length;
                const winner = drawParticipants.splice(winnerIndex, 1)[0];
                winnersListElement.innerHTML += `<li>${winner}</li>`;
            }
        }

        function getNbDigits(number) {
            return number.toString().length;
        }

        // Split {number} in an array of {nbDigits} digit numbers
        function splitIn(number, nbDigits) {

            let output = [],
            sNumber = number.toString();

            for (let i = 0, len = sNumber.length; i < len; i += nbDigits) {
                output.push(+sNumber.substring(i, i + nbDigits));
            }

            return output;
        }

        function launchFireworks(nb, delay, first = true) {
            if (first && nb > 0) {
                fireworksElmt.style.display = 'block';
                fireworks.launch(1);
                nb--;
            }

            if (nb > 0) {

                setTimeout(() => {
                    fireworks.launch(1);
                    nb--;
                    launchFireworks(nb, delay, false);
                }, delay);

            }

            if (nb == 0) {
                setTimeout(() => {
                    fireworksElmt.style.display = 'none';
                }, 2000);
            }
        }
    </script>
</head>

<body>
    <header>

        <div>
            <img alt="" class="certified-section__img" src="https://bafybeieeagq6tv4gsqep64zvg3m3hlpm2nxijvomepi34evvq745cenikq.ipfs.w3s.link/green-lock.png" />
        </div>

        <div class="certified-section__txt">
            <p>
                This random draw is secured by a decentralized algorithm leveraging the <a href="https://ipfs.tech/" target="_blank">IPFS protocol</a> and the <a href="https://ethereum.org/en/" target="_blank">Ethereum blockchain</a> in order to guarantee that the draw is <a href="#" class="verifiable-outcome-modal-open" data-id="verifiable-outcome-modal">provably fair and random</a>.
            </p>
            <p class="powered-by">
                Powered by <a href="https://www.verifiabledraws.com/" target="_blank">Verifiable Draws</a>
            </p>
        </div>

    </header>
    <div class="main">
        <div class="first-line">
            <h1 class="drawTitle">{{ drawTitle }}</h1>
            <div class="no-shrink">
                <h3 class="scheduledAt">Draw scheduled for <span class="var_scheduledAtString"></span></h3>
                <div class="drawOngoing">
                    <div class="first-line">
                        <div class="lds-dual-ring"></div>
                        <h3>Draw in progress, please wait...</h3>
                    </div>
                </div>
                <h3 class="occuredAt">Draw occured on <span class="var_scheduledAtString"></span></h3>
            </div>
        </div>
        <hr />

        <div class="draw-parameter winners">
            <h2>Draw winners:</h2>
            <ul class="draw-parameter__value winners__list">
            </ul>
            <p class="draw-parameter__value verify-sentence">
                You don't trust this result ?
                <a href="#" class="verifiable-outcome-modal-open" data-id="verifiable-outcome-modal">
                    Verify it yourself !
                </a>
            </p>
            <hr />
        </div>

        <div class="draw-parameter">
            <h2>Rules:</h2>
            <p class="draw-parameter__value">
                {{ drawRules }}
            </p>
        </div>

        <div class="draw-parameter">
            <h2><span class="var_drawNbParticipants"></span> Participants:</h2>
            <ul class="draw-parameter__value var_drawParticipants">
            </ul>
        </div>


    </div>
    <footer></footer>

    <!-- Fireworks animation -->
    <div class="fireworks"></div>

    <!-- Verifiable outcome modal -->
    <div id="verifiable-outcome-modal" class="modal" role="dialog" tabindex="-1">
        <div class="model-inner">
            <div class="modal-header">
                <h2>How to verify this draw ?</h2>
                <span class="modal-close" data-id="verifiable-outcome-modal" aria-label="Close">
                    &times;
                </span>
            </div>
            <p>
                This draw is a verifiable draw,
                which means that all participants can verify that it is performed in a fair and random way.<br /><br />
                Here are the simple steps to follow :
            </p>

            <ul>
                <li class="verification-step">
                    <strong>Verify the draw parameters</strong><br />
                    IPFS is a protocol to store tamper-proof files on the web, meaning that once a file is published on IPFS, its content cannot change.<br />
                    This page, which contains all the draw parameters, is stored on IPFS.<br />
                    To verify it, simply go to any IPFS gateway, like <a href="https://w3s.link/ipfs/cid" class="cidLink" target="_blank">w3s.link</a> or <a href="https://ipfs.io/ipfs/cid" class="cidLink" target="_blank">ipfs.io</a> and check that the source code you see match the one on this page (Right click anywhere > View page source).<br />
                    The draw parameters include: the rules, the list of participants, the number of participants to draw, the date and time of the draw, the way the random number is converted in a list of winners. All of these are set in stone thanks to the IPFS network.
                </li>
                <li class="verification-step">
                    <strong>Verify the random number</strong><br />
                    Then we need a random number, which we generate in our smart contract deployed on the blockchain.<br />
                    We rely on blockchain technology for that because it is the only way to get verifiable randomness as of today. Randomness generated outside of the blockchain cannot be verifiable because you cannot know which algorithm was used to generated the so-called randomness, it is something that only blockchain-based randomness generators allow.
                    <br /><br />
                    Go to <a href="{{ polygonscanAddress }}/address/{{ contractAddress }}#readContract#F5" target="_blank">our smart contract</a> and call the function <code>getRandomnessForDraw</code> with the parameter <code>cid = <span class="var_cid"></span></code> which is the ID of your draw that you can also find in this page's URL.
                    Check that its output is the same as the <code>randomness.bytes</code> value printed in the console of this page (Right click anywhere > Inspect > Console).
                </li>
                <li class="verification-step">
                    <strong>[Optional] Read our smart contract</strong><br />
                    You can also read <a href="{{ polygonscanAddress }}/address/{{ contractAddress }}#code#F9#L1" target="_blank">our smart contract</a> to inspect how we generate the random numbers for each draw.<br />
                    If you do so, you will notice that we leverage <a href="https://chain.link/vrf" target="_blank">Chainlink VRF</a> which is the world leading randomness provider on the blockchain.<br />
                    Therefore, you benefit from the most secure randomness while everything is 100% verifiable because Chainlink rely solely on public smart contracts as well.
                </li>
            </ul>

            <p>
                That's it, you now know that this draw is not rigged. ð<br />
                If you have further questions you can reach out to the <i>Verifiable Draws</i> team on <a href="https://discord.gg/3YjqW9MP7H" target="_blank">our Discord server</a>, we will be happy to help you.
            </p>

        </div>
    </div>


</body>

</html>